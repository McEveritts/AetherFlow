#!/bin/bash
#
# [AetherFlow :: Install Ombi]
# Media request management for Plex/Emby/Jellyfin
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ombi] $1" | tee -a "$LOGFILE"; }

# ── Dependencies ─────────────────────────────────────────────────────────────
log "Installing dependencies..."
apt-get update >>"$LOGFILE" 2>&1
apt-get install -y curl libicu-dev >>"$LOGFILE" 2>&1

# ── Download Ombi ────────────────────────────────────────────────────────────
log "Downloading latest Ombi..."
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
    amd64) OMBI_ARCH="linux-x64" ;;
    arm64) OMBI_ARCH="linux-arm64" ;;
    *) OMBI_ARCH="linux-x64" ;;
esac

OMBI_URL=$(curl -sL https://api.github.com/repos/Ombi-app/Ombi/releases/latest | grep "browser_download_url.*${OMBI_ARCH}.tar.gz" | head -1 | cut -d '"' -f 4)
if [[ -z "$OMBI_URL" ]]; then
    log "Could not determine latest Ombi URL, using latest tag..."
    OMBI_VERSION=$(curl -sL https://api.github.com/repos/Ombi-app/Ombi/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    OMBI_URL="https://github.com/Ombi-app/Ombi/releases/download/v${OMBI_VERSION}/linux-x64.tar.gz"
fi

mkdir -p /opt/Ombi /tmp/AetherFlow
cd /tmp/AetherFlow
curl -sL "$OMBI_URL" -o ombi.tar.gz >>"$LOGFILE" 2>&1
tar -xzf ombi.tar.gz -C /opt/Ombi >>"$LOGFILE" 2>&1
rm -f ombi.tar.gz

# ── Create ombi user ─────────────────────────────────────────────────────────
if ! id -u ombi &>/dev/null; then
    useradd -r -s /usr/sbin/nologin -d /opt/Ombi ombi
fi
chown -R ombi:ombi /opt/Ombi

# ── Systemd service ──────────────────────────────────────────────────────────
log "Creating systemd service..."
cat > /etc/systemd/system/ombi.service <<'EOF'
[Unit]
Description=Ombi - Media Request Manager
After=network.target

[Service]
Type=simple
User=ombi
Group=ombi
WorkingDirectory=/opt/Ombi
ExecStart=/opt/Ombi/Ombi --host http://0.0.0.0:5000 --storage /opt/Ombi
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ombi.service >>"$LOGFILE" 2>&1
systemctl start ombi.service

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/ombi.conf <<'EOF'
<Location /ombi>
    ProxyPass http://localhost:5000/ombi
    ProxyPassReverse http://localhost:5000/ombi
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/ombi.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.ombi.lock
log "Ombi installation complete! Access at http://your-server:5000"
