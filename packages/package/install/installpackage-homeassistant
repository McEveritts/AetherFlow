#!/bin/bash
#
# [AetherFlow :: Install Home Assistant]
# Open source home automation platform
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [homeassistant] $1" | tee -a "$LOGFILE"; }

# ── Install system dependencies ──────────────────────────────────────────────
log "Installing system dependencies..."
apt-get update >>"$LOGFILE" 2>&1
apt-get install -y python3 python3-dev python3-venv python3-pip \
    bluez libffi-dev libssl-dev libjpeg-dev zlib1g-dev \
    autoconf build-essential libopenjp2-7 libtiff6 libturbojpeg0-dev \
    tzdata ffmpeg liblapack3 liblapack-dev libatlas-base-dev >>"$LOGFILE" 2>&1

# ── Create homeassistant user ────────────────────────────────────────────────
log "Creating homeassistant system user..."
if ! id -u homeassistant &>/dev/null; then
    useradd -rm -s /bin/bash -d /home/homeassistant -G dialout,gpio,i2c homeassistant 2>>"$LOGFILE" || \
    useradd -rm -s /bin/bash -d /home/homeassistant -G dialout homeassistant 2>>"$LOGFILE"
fi

# ── Create virtual environment and install HA ────────────────────────────────
log "Creating Python virtual environment..."
sudo -u homeassistant bash -c '
    python3 -m venv /home/homeassistant/homeassistant_venv
    source /home/homeassistant/homeassistant_venv/bin/activate
    pip install --upgrade pip wheel setuptools
    pip install homeassistant
' >>"$LOGFILE" 2>&1

# ── Systemd service ──────────────────────────────────────────────────────────
log "Creating systemd service..."
cat > /etc/systemd/system/home-assistant@homeassistant.service <<'EOF'
[Unit]
Description=Home Assistant
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=homeassistant
WorkingDirectory=/home/homeassistant
ExecStart=/home/homeassistant/homeassistant_venv/bin/hass -c "/home/homeassistant/.homeassistant"
Restart=on-failure
RestartSec=10
KillSignal=SIGINT
SendSIGKILL=no

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable home-assistant@homeassistant.service >>"$LOGFILE" 2>&1
systemctl start home-assistant@homeassistant.service

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/homeassistant.conf <<'EOF'
<Location /homeassistant>
    ProxyPass http://localhost:8123
    ProxyPassReverse http://localhost:8123
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/homeassistant.conf
a2enmod proxy proxy_http proxy_wstunnel headers >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.homeassistant.lock
log "Home Assistant installation complete! Access at http://your-server:8123"
log "NOTE: First startup may take 10-20 minutes to initialize."
