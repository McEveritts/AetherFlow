#!/bin/bash
#
# [AetherFlow :: Install WireGuard]
# Fast, modern, and secure VPN tunnel
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [wireguard] $1" | tee -a "$LOGFILE"; }

# ── Install WireGuard ────────────────────────────────────────────────────────
log "Installing WireGuard and dependencies..."
apt-get update >>"$LOGFILE" 2>&1
apt-get install -y wireguard wireguard-tools qrencode iptables >>"$LOGFILE" 2>&1

# ── Generate server keys ─────────────────────────────────────────────────────
log "Generating WireGuard server keys..."
mkdir -p /etc/wireguard
umask 077
wg genkey | tee /etc/wireguard/server_private.key | wg pubkey > /etc/wireguard/server_public.key

SERVER_PRIVATE=$(cat /etc/wireguard/server_private.key)
SERVER_PUBLIC=$(cat /etc/wireguard/server_public.key)
SERVER_IP=$(hostname -I | awk '{print $1}')
DEFAULT_IFACE=$(ip route | grep default | awk '{print $5}' | head -1)

# ── Create wg0 configuration ─────────────────────────────────────────────────
log "Creating WireGuard interface configuration..."
cat > /etc/wireguard/wg0.conf <<EOF
[Interface]
Address = 10.66.66.1/24
ListenPort = 51820
PrivateKey = ${SERVER_PRIVATE}
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o ${DEFAULT_IFACE} -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o ${DEFAULT_IFACE} -j MASQUERADE
SaveConfig = true

# Add peers with: wg set wg0 peer <client_pubkey> allowed-ips 10.66.66.x/32
EOF

chmod 600 /etc/wireguard/wg0.conf

# ── Enable IP forwarding ─────────────────────────────────────────────────────
log "Enabling IP forwarding..."
if ! grep -q "net.ipv4.ip_forward=1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
fi
sysctl -p >>"$LOGFILE" 2>&1

# ── Start WireGuard ──────────────────────────────────────────────────────────
log "Starting WireGuard..."
systemctl enable wg-quick@wg0 >>"$LOGFILE" 2>&1
systemctl start wg-quick@wg0

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.wireguard.lock
log "WireGuard installation complete!"
log "Server public key: ${SERVER_PUBLIC}"
log "Server endpoint: ${SERVER_IP}:51820"
log "VPN subnet: 10.66.66.0/24"
echo "${SERVER_PUBLIC}" > /opt/AetherFlow/logs/wireguard_pubkey.txt
