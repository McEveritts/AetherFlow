#!/bin/bash
#
# [AetherFlow :: Install NZBGet]
# Efficient Usenet downloader
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [nzbget] $1" | tee -a "$LOGFILE"; }

# ── Dependencies ─────────────────────────────────────────────────────────────
log "Installing dependencies..."
apt-get update >>"$LOGFILE" 2>&1
apt-get install -y unrar p7zip-full >>"$LOGFILE" 2>&1

# ── Download NZBGet ──────────────────────────────────────────────────────────
log "Downloading latest NZBGet..."
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
    amd64) NZBGET_ARCH="linux" ;;
    arm64) NZBGET_ARCH="linux" ;;
    *) NZBGET_ARCH="linux" ;;
esac

NZBGET_URL=$(curl -sL https://api.github.com/repos/nzbgetcom/nzbget/releases/latest | grep "browser_download_url.*${NZBGET_ARCH}-bin" | head -1 | cut -d '"' -f 4)
if [[ -z "$NZBGET_URL" ]]; then
    NZBGET_URL="https://github.com/nzbgetcom/nzbget/releases/latest/download/nzbget-linux.run"
fi

mkdir -p /tmp/AetherFlow
cd /tmp/AetherFlow
curl -sL "$NZBGET_URL" -o nzbget-installer.run >>"$LOGFILE" 2>&1
chmod +x nzbget-installer.run
sh nzbget-installer.run --destdir /opt/nzbget >>"$LOGFILE" 2>&1
rm -f nzbget-installer.run

# ── Create nzbget user ───────────────────────────────────────────────────────
if ! id -u nzbget &>/dev/null; then
    useradd -r -s /usr/sbin/nologin -d /opt/nzbget nzbget
fi
mkdir -p /home/nzbget/Downloads
chown -R nzbget:nzbget /opt/nzbget /home/nzbget

# ── Systemd service ──────────────────────────────────────────────────────────
log "Creating systemd service..."
cat > /etc/systemd/system/nzbget.service <<'EOF'
[Unit]
Description=NZBGet Usenet Downloader
After=network.target

[Service]
Type=forking
User=nzbget
Group=nzbget
ExecStart=/opt/nzbget/nzbget -D
ExecStop=/opt/nzbget/nzbget -Q
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable nzbget.service >>"$LOGFILE" 2>&1
systemctl start nzbget.service

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/nzbget.conf <<'EOF'
<Location /nzbget>
    ProxyPass http://localhost:6789
    ProxyPassReverse http://localhost:6789
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/nzbget.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.nzbget.lock
log "NZBGet installation complete! Default login: nzbget / tegbzn6789"
log "Access at http://your-server:6789"
