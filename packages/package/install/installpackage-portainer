#!/bin/bash
#
# [AetherFlow :: Install Portainer]
# Lightweight container management UI for Docker
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [portainer] $1" | tee -a "$LOGFILE"; }

# ── Install Docker if not present ────────────────────────────────────────────
if ! command -v docker &>/dev/null; then
    log "Docker not found — installing Docker Engine..."
    curl -fsSL https://get.docker.com | sh >>"$LOGFILE" 2>&1
    systemctl enable docker >>"$LOGFILE" 2>&1
    systemctl start docker
    log "Docker installed successfully."
else
    log "Docker already installed."
fi

# ── Create Portainer data volume ─────────────────────────────────────────────
log "Creating Portainer data volume..."
docker volume create portainer_data >>"$LOGFILE" 2>&1 || true

# ── Deploy Portainer container ───────────────────────────────────────────────
log "Pulling and starting Portainer CE container..."
docker rm -f portainer 2>/dev/null || true
docker run -d \
    --name portainer \
    --restart=always \
    -p 9443:9443 \
    -p 9000:9000 \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v portainer_data:/data \
    portainer/portainer-ce:latest >>"$LOGFILE" 2>&1

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/portainer.conf <<'EOF'
<Location /portainer>
    ProxyPass http://localhost:9000
    ProxyPassReverse http://localhost:9000
    ProxyPreserveHost On
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/portainer.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.portainer.lock
log "Portainer installation complete! Access at https://your-server:9443"
