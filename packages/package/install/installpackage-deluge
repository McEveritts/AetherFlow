#!/bin/bash
#
# [AetherFlow :: Install Deluge]
# Feature-rich BitTorrent client with web UI
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [deluge] $1" | tee -a "$LOGFILE"; }

# ── Install Deluge ───────────────────────────────────────────────────────────
log "Installing Deluge daemon and web UI..."
apt-get update >>"$LOGFILE" 2>&1
apt-get install -y deluged deluge-web deluge-console >>"$LOGFILE" 2>&1

# ── Create deluge user ───────────────────────────────────────────────────────
if ! id -u deluge &>/dev/null; then
    useradd -r -s /usr/sbin/nologin -m -d /home/deluge deluge
fi
mkdir -p /home/deluge/Downloads /home/deluge/.config/deluge
chown -R deluge:deluge /home/deluge

# ── Systemd services (daemon + web) ─────────────────────────────────────────
log "Creating systemd services..."
cat > /etc/systemd/system/deluged.service <<'EOF'
[Unit]
Description=Deluge Bittorrent Client Daemon
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=deluge
Group=deluge
ExecStart=/usr/bin/deluged -d -l /var/log/deluge/daemon.log -L warning
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

cat > /etc/systemd/system/deluge-web.service <<'EOF'
[Unit]
Description=Deluge Bittorrent Client Web Interface
After=network-online.target deluged.service
Wants=deluged.service

[Service]
Type=simple
User=deluge
Group=deluge
ExecStart=/usr/bin/deluge-web -d -l /var/log/deluge/web.log -L warning
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

mkdir -p /var/log/deluge
chown -R deluge:deluge /var/log/deluge
systemctl daemon-reload
systemctl enable deluged.service deluge-web.service >>"$LOGFILE" 2>&1
systemctl start deluged.service
sleep 2
systemctl start deluge-web.service

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/deluge.conf <<'EOF'
<Location /deluge>
    ProxyPass http://localhost:8112/deluge
    ProxyPassReverse http://localhost:8112/deluge
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/deluge.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.deluge.lock
log "Deluge installation complete! Default web password: deluge"
log "Access at http://your-server:8112"
