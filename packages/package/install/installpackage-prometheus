#!/bin/bash
#
# [AetherFlow :: Install Prometheus]
# Systems monitoring and alerting toolkit
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [prometheus] $1" | tee -a "$LOGFILE"; }

# ── Create prometheus user ────────────────────────────────────────────────────
log "Creating prometheus system user..."
if ! id -u prometheus &>/dev/null; then
    useradd -r -s /usr/sbin/nologin -d /opt/prometheus prometheus
fi

# ── Download Prometheus ───────────────────────────────────────────────────────
log "Downloading latest Prometheus..."
ARCH=$(dpkg --print-architecture)
case "$ARCH" in
    amd64) PROM_ARCH="linux-amd64" ;;
    arm64) PROM_ARCH="linux-arm64" ;;
    armhf) PROM_ARCH="linux-armv7" ;;
    *) PROM_ARCH="linux-amd64" ;;
esac

PROM_VERSION=$(curl -sL https://api.github.com/repos/prometheus/prometheus/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
if [[ -z "$PROM_VERSION" ]]; then
    PROM_VERSION="2.51.2"
fi

cd /tmp
curl -sLO "https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.${PROM_ARCH}.tar.gz" >>"$LOGFILE" 2>&1
tar -xzf "prometheus-${PROM_VERSION}.${PROM_ARCH}.tar.gz" >>"$LOGFILE" 2>&1

# ── Install binaries and config ───────────────────────────────────────────────
log "Installing Prometheus binaries..."
mkdir -p /opt/prometheus /etc/prometheus /var/lib/prometheus

cp "prometheus-${PROM_VERSION}.${PROM_ARCH}/prometheus" /opt/prometheus/
cp "prometheus-${PROM_VERSION}.${PROM_ARCH}/promtool" /opt/prometheus/
cp -r "prometheus-${PROM_VERSION}.${PROM_ARCH}/consoles" /etc/prometheus/
cp -r "prometheus-${PROM_VERSION}.${PROM_ARCH}/console_libraries" /etc/prometheus/

# Default config: scrape itself
cat > /etc/prometheus/prometheus.yml <<'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "node"
    static_configs:
      - targets: ["localhost:9100"]
EOF

chown -R prometheus:prometheus /opt/prometheus /etc/prometheus /var/lib/prometheus
rm -rf "/tmp/prometheus-${PROM_VERSION}.${PROM_ARCH}"*

# ── Also install node_exporter ────────────────────────────────────────────────
log "Installing node_exporter for system metrics..."
NODE_VERSION=$(curl -sL https://api.github.com/repos/prometheus/node_exporter/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
if [[ -z "$NODE_VERSION" ]]; then
    NODE_VERSION="1.8.1"
fi

cd /tmp
curl -sLO "https://github.com/prometheus/node_exporter/releases/download/v${NODE_VERSION}/node_exporter-${NODE_VERSION}.${PROM_ARCH}.tar.gz" >>"$LOGFILE" 2>&1
tar -xzf "node_exporter-${NODE_VERSION}.${PROM_ARCH}.tar.gz" >>"$LOGFILE" 2>&1
cp "node_exporter-${NODE_VERSION}.${PROM_ARCH}/node_exporter" /opt/prometheus/
rm -rf "/tmp/node_exporter-${NODE_VERSION}.${PROM_ARCH}"*

# ── Systemd services ─────────────────────────────────────────────────────────
log "Creating systemd services..."
cat > /etc/systemd/system/prometheus.service <<'EOF'
[Unit]
Description=Prometheus Monitoring System
After=network.target

[Service]
Type=simple
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/prometheus \
    --config.file=/etc/prometheus/prometheus.yml \
    --storage.tsdb.path=/var/lib/prometheus/ \
    --web.console.templates=/etc/prometheus/consoles \
    --web.console.libraries=/etc/prometheus/console_libraries \
    --web.listen-address=:9090
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

cat > /etc/systemd/system/node_exporter.service <<'EOF'
[Unit]
Description=Prometheus Node Exporter
After=network.target

[Service]
Type=simple
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/node_exporter
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable prometheus.service node_exporter.service >>"$LOGFILE" 2>&1
systemctl start prometheus.service node_exporter.service

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/prometheus.conf <<'EOF'
<Location /prometheus>
    ProxyPass http://localhost:9090/prometheus
    ProxyPassReverse http://localhost:9090/prometheus
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/prometheus.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.prometheus.lock
log "Prometheus + node_exporter installation complete! Access at http://your-server:9090"
