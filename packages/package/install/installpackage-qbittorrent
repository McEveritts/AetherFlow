#!/bin/bash
#
# [AetherFlow :: Install qBittorrent]
# Lightweight and feature-rich BitTorrent client
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [qbittorrent] $1" | tee -a "$LOGFILE"; }

# ── Install qBittorrent-nox ──────────────────────────────────────────────────
log "Installing qBittorrent-nox (headless)..."
apt-get update >>"$LOGFILE" 2>&1
apt-get install -y qbittorrent-nox >>"$LOGFILE" 2>&1

# ── Create qbittorrent user ─────────────────────────────────────────────────
if ! id -u qbittorrent &>/dev/null; then
    useradd -r -s /usr/sbin/nologin -m -d /home/qbittorrent qbittorrent
fi

# ── Create required directories ──────────────────────────────────────────────
mkdir -p /home/qbittorrent/Downloads /home/qbittorrent/.config/qBittorrent
chown -R qbittorrent:qbittorrent /home/qbittorrent

# ── Initial configuration ────────────────────────────────────────────────────
log "Writing initial configuration..."
cat > /home/qbittorrent/.config/qBittorrent/qBittorrent.conf <<'EOF'
[Preferences]
WebUI\Port=8180
WebUI\Address=0.0.0.0
WebUI\Username=admin
WebUI\CSRFProtection=false
Downloads\SavePath=/home/qbittorrent/Downloads
Connection\PortRangeMin=6881
EOF
chown -R qbittorrent:qbittorrent /home/qbittorrent/.config

# ── Systemd service ──────────────────────────────────────────────────────────
log "Creating systemd service..."
cat > /etc/systemd/system/qbittorrent.service <<'EOF'
[Unit]
Description=qBittorrent-nox Daemon
After=network.target

[Service]
Type=simple
User=qbittorrent
Group=qbittorrent
ExecStart=/usr/bin/qbittorrent-nox --webui-port=8180
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable qbittorrent.service >>"$LOGFILE" 2>&1
systemctl start qbittorrent.service

# ── Apache reverse proxy ─────────────────────────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/qbittorrent.conf <<'EOF'
<Location /qbittorrent>
    ProxyPass http://localhost:8180
    ProxyPassReverse http://localhost:8180
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/qbittorrent.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.qbittorrent.lock
log "qBittorrent installation complete! Default login: admin / adminadmin"
log "Access at http://your-server:8180"
