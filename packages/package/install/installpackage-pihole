#!/bin/bash
#
# [AetherFlow :: Install Pi-hole]
# Network-wide ad blocking via DNS sinkhole
#
# Author : McEveritts
# URL    : https://AetherFlow.io
# License: GPL-3.0
#
set -e

LOGFILE="/opt/AetherFlow/logs/installer.log"
mkdir -p /opt/AetherFlow/logs /install /etc/pihole

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [pihole] $1" | tee -a "$LOGFILE"; }

# ── Pre-configure Pi-hole for unattended install ─────────────────────────────
log "Pre-configuring Pi-hole for automated install..."
PIHOLE_INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1)
PIHOLE_IP=$(hostname -I | awk '{print $1}')

cat > /etc/pihole/setupVars.conf <<EOF
PIHOLE_INTERFACE=${PIHOLE_INTERFACE}
IPV4_ADDRESS=${PIHOLE_IP}/24
IPV6_ADDRESS=
PIHOLE_DNS_1=1.1.1.1
PIHOLE_DNS_2=8.8.8.8
QUERY_LOGGING=true
INSTALL_WEB_SERVER=false
INSTALL_WEB_INTERFACE=true
LIGHTTPD_ENABLED=false
CACHE_SIZE=10000
DNS_FQDN_REQUIRED=true
DNS_BOGUS_PRIV=true
DNSMASQ_LISTENING=local
WEBPASSWORD=
BLOCKING_ENABLED=true
EOF

# ── Install Pi-hole ──────────────────────────────────────────────────────────
log "Downloading and running Pi-hole installer (unattended)..."
curl -sSL https://install.pi-hole.net | bash /dev/stdin --unattended >>"$LOGFILE" 2>&1

# ── Set a random web password ────────────────────────────────────────────────
PIHOLE_PASS=$(openssl rand -base64 12)
pihole -a -p "$PIHOLE_PASS" >>"$LOGFILE" 2>&1
log "Pi-hole admin password set to: ${PIHOLE_PASS}"
echo "$PIHOLE_PASS" > /opt/AetherFlow/logs/pihole_password.txt
chmod 600 /opt/AetherFlow/logs/pihole_password.txt

# ── Apache reverse proxy for the admin panel ─────────────────────────────────
log "Configuring Apache reverse proxy..."
cat > /etc/apache2/sites-enabled/pihole.conf <<'EOF'
<Location /pihole>
    ProxyPass http://localhost:8089/admin
    ProxyPassReverse http://localhost:8089/admin
</Location>
EOF
chown www-data:www-data /etc/apache2/sites-enabled/pihole.conf
a2enmod proxy proxy_http >>/dev/null 2>&1
service apache2 reload >>"$LOGFILE" 2>&1

# ── Finalize ─────────────────────────────────────────────────────────────────
touch /install/.pihole.lock
log "Pi-hole installation complete! Admin password saved to /opt/AetherFlow/logs/pihole_password.txt"
