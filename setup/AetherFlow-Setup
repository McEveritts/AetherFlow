#!/bin/bash
################################################################################
# AetherFlow Installation Script
#
# GitHub:   https://github.com/McEveritts/AetherFlow
# Author:   McEveritts
# URL:      https://aetherflow.io
#
# AetherFlow Copyright (C) 2017-2022 AetherFlow.io
# Licensed under GNU General Public License v3.0 GPL-3 (in short)
#
#   You may copy, distribute and modify the software as long as you track
#   changes/dates in source files. Any modifications to our software
#   including (via compiler) GPL-licensed code must also be made available
#   under the GPL along with build & install instructions.
#
#################################################################################
#Script Console Colors
black=$(tput setaf 0)
red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)
# Ensure system binaries are in PATH
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"

on_red=$(tput setab 1)
on_green=$(tput setab 2)
on_magenta=$(tput setab 5)
bold=$(tput bold)
standout=$(tput smso)
normal=$(tput sgr0)
alert=${white}${on_red}
title=${standout}
repo_title=${black}${on_green}
message_title=${white}${on_magenta}
#################################################################################

# Check if running from setup directory or installed location
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Auto-Bootstrap if downloaded as a single script via the GitHub one-liner
if [[ ! -d "${SCRIPT_DIR}/modules" ]]; then
    echo "Bootstrapping AetherFlow Installer Environment..."
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y >/dev/null 2>&1
    apt-get install -y git bc curl >/dev/null 2>&1
    
    rm -rf /opt/AetherFlow
    git clone https://github.com/McEveritts/AetherFlow.git /opt/AetherFlow >/dev/null 2>&1
    
    # Relaunch from the proper directory
    cd /opt/AetherFlow/setup || exit 1
    exec bash AetherFlow-Setup "$@"
    exit 0
fi

# We are in the correct bootstrapped setup directory
BASE_DIR="$(dirname "${SCRIPT_DIR}")"
local_setup="${SCRIPT_DIR}/"
local_packages="${BASE_DIR}/packages/"

# Load Modules (06-state.sh loads first due to sort order after 05-)
for module in "${SCRIPT_DIR}/modules/"*.sh; do
    # shellcheck disable=1090
    source "$module"
done

################################################################################
# CLI Argument Parsing
################################################################################

REPAIR_STEPS=""
FRESH_INSTALL=false
RESUME_MODE=false
LIST_ONLY=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --resume)
            RESUME_MODE=true
            shift
            ;;
        --repair)
            shift
            # Collect all repair step IDs until next flag or end
            while [[ $# -gt 0 && ! "$1" =~ ^-- ]]; do
                REPAIR_STEPS="${REPAIR_STEPS} $1"
                shift
            done
            ;;
        --fresh)
            FRESH_INSTALL=true
            shift
            ;;
        --list-steps)
            LIST_ONLY=true
            shift
            ;;
        --help|-h)
            echo ""
            echo "AetherFlow Installer"
            echo "===================="
            echo ""
            echo "Usage: bash AetherFlow-Setup [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --resume         Resume from last successful step (default if state exists)"
            echo "  --repair <step>  Force re-run specific step(s) by ID"
            echo "  --fresh          Wipe all state and start from scratch"
            echo "  --list-steps     Show all steps and their completion status"
            echo "  --help, -h       Show this help message"
            echo ""
            echo "Examples:"
            echo "  bash AetherFlow-Setup                    # Fresh install or auto-resume"
            echo "  bash AetherFlow-Setup --resume            # Resume after failure"
            echo "  bash AetherFlow-Setup --repair build_modern  # Re-run just the build step"
            echo "  bash AetherFlow-Setup --repair xmlrpc libtorrent rtorrent"
            echo "  bash AetherFlow-Setup --list-steps        # See progress"
            echo ""
            exit 0
            ;;
        *)
            echo "Unknown option: $1 (try --help)"
            exit 1
            ;;
    esac
done

# Export for use in 06-state.sh functions
export REPAIR_STEPS
export FRESH_INSTALL

################################################################################
# State Initialization
################################################################################

_init_state
if [[ -f "${CONFIG_FILE}" ]]; then
    source "${CONFIG_FILE}" 2>/dev/null
fi

# Failsafe: ensure OUTTO always has a valid value
OUTTO="${OUTTO:-/dev/null}"

# Handle --list-steps
if [[ "${LIST_ONLY}" == "true" ]]; then
    _list_steps
    exit 0
fi

# Handle --fresh
if [[ "${FRESH_INSTALL}" == "true" ]]; then
    echo "Wiping previous installation state..."
    _cleanup_state
fi

# Detect previous install (auto-resume)
if [[ -z "${REPAIR_STEPS}" ]] && [[ "${FRESH_INSTALL}" == "false" ]]; then
    _detect_previous_install
fi

clear

# shellcheck disable=2312,2243,1003
spinner() {
	local pid=$1
	local delay=0.25
	local spinstr='|/-\'
	while [[ "$(ps a | awk '{print $1}' | grep ${pid})" ]]; do
		local temp=${spinstr#?}
		printf " [${bold}${yellow}%c${normal}]  " "${spinstr}"
		local spinstr=${temp}${spinstr%"${temp}"}
		sleep "${delay}"
		printf "\b\b\b\b\b\b"
	done
	printf "    \b\b\b\b"
	echo -ne "${OK}"
}
if [[ ! -d "${local_setup}" ]]; then
    echo "Critical Error: Setup paths failed to resolve."
    exit 1
fi
# shellcheck disable=2312
IFACE=$(ip link show | grep -i broadcast | grep -m1 UP | cut -d: -f 2 | cut -d@ -f 1 | sed -e 's/ //g')
PORT=$(shuf -i 2000-61000 -n 1)
PORTEND=$((${PORT} + 1500))
# shellcheck disable=2312
while [[ "$(netstat -ln | grep ':'${PORT}'' | grep -c 'LISTEN')" -eq "1" ]]; do PORT="$(shuf -i 2000-61000 -n 1)"; done
RPORT=$(shuf -i 2000-61000 -n 1)
# shellcheck disable=2312
while [[ "$(netstat -ln | grep ':'${RPORT}'' | grep -c 'LISTEN')" -eq "1" ]]; do RPORT="$(shuf -i 2000-61000 -n 1)"; done
S=$(date +%s)
OK=$(echo -e "[ ${bold}${green}DONE${normal} ]")
genpass=$(_string)
HTPASSWD="/etc/htpasswd"
REALM="aetherflow"
AUTODLPASSWORD=$(_string)
AUTODLPORT=$(shuf -i 2000-61000 -n 1)
# shellcheck disable=2312
ip=$(ip route get 8.8.8.8 | awk 'NR==1 {print $7}')
export DEBIAN_FRONTEND=noninteractive
cd

################################################################################
# PHASE 1: System Checks & User Prompts
#   These run in the foreground since they require user interaction
################################################################################

_run_step_fg "bashrc" "Setting up shell environment" _bashrc
_run_step_fg "intro" "Checking distribution compatibility" _intro
_run_step_fg "checkroot" "Verifying root privileges" _checkroot
_run_step_fg "logcheck" "Configuring log output" _logcheck
_run_step_fg "checkkernel" "Checking kernel compatibility" _checkkernel
_run_step_fg "hostname" "Setting hostname" _hostname

_run_step_fg "askcontinue" "Ready to proceed" _askcontinue
_run_step_fg "ssdpblock" "Blocking insecure SSDP port" _ssdpblock
_run_step_fg "locale" "Setting locale" _locale
clear

_run_step_fg "askpartition" "Partition selection" _askpartition
_run_step_fg "ask10g" "10G network check" _ask10g
_run_step_fg "askrtorrent" "rTorrent version selection" _askrtorrent

_run_step_fg "asktr" "Transmission preference" _asktr
apt-get install -q -y curl >>"${OUTTO}" 2>&1
_run_step_fg "askqb" "qBittorrent preference" _askqb
_run_step_fg "askdashtheme" "Dashboard theme" _askdashtheme
_run_step_fg "adduser" "Adding master user" _adduser
_run_step_fg "askffmpeg" "FFmpeg preference" _askffmpeg
_run_step_fg "askvsftpd" "FTP configuration" _askvsftpd
_run_step_fg "denyhosts" "Public tracker blocking" _denyhosts
_run_step_fg "askbbr" "BBR congestion control preference" _askbbr
clear

################################################################################
# PHASE 2: Installation
#   These run backgrounded with spinner animation
################################################################################

echo
echo ""
echo "${bold}${magenta}AetherFlow will now install, this may take between${normal}"
echo "${bold}${magenta}10 and 45 minutes depending on your systems specs${normal}"
echo ""

_run_step "repos" "Pulling AetherFlow Ecosystem" _repos
_run_step "updates" "Updating system" _updates
_run_step "depends" "Installing all needed dependencies" _depends

if [[ ${RTVERSION} != 0.9.7 ]]; then
	_run_step "openssl" "Installing openssl" _openssl
fi

_run_step "syscommands" "Setting up system executables" _syscommands
_run_step "skel" "Building required user directories" _skel



_run_step "lshell" "Setting up Limited Shell environment" _lshell

if [[ ${ffmpeg} == "yes" ]]; then
	_run_step "ffmpeg" "Building ffmpeg from source for screenshots" _ffmpeg
fi

_run_step_fg "apachesudo" "Configuring Apache sudo" _apachesudo
_run_step "xmlrpc" "Installing xmlrpc-c" _xmlrpc
_run_step "libtorrent" "Installing libtorrent-rakshasa ${green}${LTORRENT}${normal}" _libtorrent
_run_step "rtorrent" "Installing rtorrent-${green}${RTVERSION}${normal}" _rtorrent

# NOTE: ruTorrent installation removed — sunset in favor of Next.js frontend

if [[ ${tr} == "yes" ]]; then
	_run_step "transmission" "Configuring Transmission" _insTr
	_run_step "transmission_web" "Installing Transmission Web Control" _insTrWeb
	_run_step "transmission_apache" "Setting up Transmission Reverse Proxy" _insTrApache
fi
if [[ ${QBVERSION} != "no" ]]; then
	_run_step "qbittorrent" "Installing qBittorrent" _qbittorrent
	_run_step "qbittorrent_apache" "Setting up qBittorrent Reverse Proxy" _insqBApache
fi

# NOTE: Legacy PHP dashboard removed — Next.js frontend is the sole UI
_run_step "install_go" "Installing Go compiler" _install_go
_run_step "install_node" "Installing Node.js and PM2" _install_node
_run_step "build_modern" "Building Next.js and Go API" _build_modern_stack

_run_step "apacheconf" "Setting up seedbox.conf for apache" _apacheconf
_run_step "fix_cert" "Fix SSL Cert for apache" _fix_cert
_run_step "rconf" "Installing .rtorrent.rc for ${username}" _rconf
# NOTE: ruTorrent plugin configuration removed
_run_step "autodl" "Installing autodl-irssi" _autodl
_run_step "makedirs" "Making ${username} directory structure" _makedirs
# NOTE: ruTorrent user config removed
_run_step "installftpd" "Installing vsftpd" _installftpd
_run_step "ftpdconfig" "Setting up vsftpd" _ftpdconfig
# NOTE: _quickstats removed — legacy PHP dashboard sunset
_run_step_fg "quickconsole" "Setting up web console" _quickconsole
_run_step "boot" "Setting irssi/rtorrent to start on boot" _boot
_run_step "perms" "Setting permissions on ${username}" _perms

if [[ ${bbr} == "yes" ]]; then
	_run_step "bbr" "Installing BBR" _insbbr
fi
# shellcheck disable=2312
if lspci | grep -i bcm >/dev/null; then
	_run_step "bcm" "Installing firmware for BCM NIC" _insbcm
fi

cd
E=$(date +%s)
DIFF=$(echo "${E}" - "${S}" | bc)
FIN=$(echo "${DIFF}" / 60 | bc)
clear
_finished
